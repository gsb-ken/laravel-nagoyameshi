version: 0.2

phases:
  pre_build:
    commands:
      - echo "AWS_REGION=${AWS_REGION}"
      - echo "AWS_ACCOUNT_ID=${AWS_ACCOUNT_ID}"
      - echo "PROJECT=${PROJECT}"
      - echo "ENVIRONMENT=${ENVIRONMENT}"
      - echo "[PRE_BUILD] Logging in to Amazon ECR..."
      - aws ecr get-login-password --region ${AWS_REGION} | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com

  build:
    commands:
      - echo "[BUILD] Building Laravel Docker image..."
      - docker build --no-cache -f Dockerfile.deployment -t ${CONTAINER_NAME} .
      - docker tag ${CONTAINER_NAME} ${REPOSITORY_URI}:latest

  post_build:
    commands:
      - echo "[POST_BUILD] Pushing image to ECR..."
      - docker push ${REPOSITORY_URI}:latest

      - echo "MIGRATION_TASK_DEFINITION=${MIGRATION_TASK_DEFINITION}"
      - echo "ECS_CLUSTER_NAME=${ECS_CLUSTER_NAME}"
      - echo "SUBNET_ID_1=${SUBNET_ID_1}"
      - echo "SUBNET_ID_2=${SUBNET_ID_2}"
      - echo "SECURITY_GROUP_ID=${SECURITY_GROUP_ID}"

      - |
        echo "[POST_BUILD] Running Laravel migration in PUBLIC subnet (test for NAT issue)"
        RUN_TASK_OUTPUT=$(aws ecs run-task \
          --cluster ${ECS_CLUSTER_NAME} \
          --launch-type FARGATE \
          --task-definition ${MIGRATION_TASK_DEFINITION} \
          --network-configuration "awsvpcConfiguration={subnets=[${PUBLIC_SUBNET_ID_1},${PUBLIC_SUBNET_ID_2}],securityGroups=[${SECURITY_GROUP_ID}],assignPublicIp=ENABLED}" \
          --region ap-northeast-1 \
          --output json)
        echo "$RUN_TASK_OUTPUT"

        TASK_ARN=$(echo "$RUN_TASK_OUTPUT" | jq -r '.tasks[0].taskArn // empty')
        if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" = "null" ]; then
          echo "[ERROR] Failed to start migration task. TASK_ARN is empty."
          exit 1
        fi

        echo "[INFO] Migration task started: $TASK_ARN"
        echo "[INFO] Waiting for task to finish..."
        aws ecs wait tasks-stopped --cluster ${ECS_CLUSTER_NAME} --tasks $TASK_ARN --region ap-northeast-1

        echo "[INFO] Waiting for CloudWatch Logs for migration task..."
        LOG_GROUP="/ecs/${PROJECT}-${ENVIRONMENT}/task/migrate"

        for i in {1..6}; do
          LOG_STREAM=$(aws logs describe-log-streams \
            --log-group-name "$LOG_GROUP" \
            --order-by LastEventTime \
            --descending \
            --max-items 1 \
            --query "logStreams[0].logStreamName" \
            --output text \
            --region ap-northeast-1 2>/dev/null || echo "")

          if [ -n "$LOG_STREAM" ] && [ "$LOG_STREAM" != "None" ]; then
            echo "[INFO] Found log stream: $LOG_STREAM"
            break
          fi

          echo "[INFO] Log stream not found yet. Retrying in 5 seconds..."
          sleep 5
        done

        if [ -z "$LOG_STREAM" ] || [ "$LOG_STREAM" = "None" ]; then
          echo "[WARN] No log stream found for migration task after waiting."
        else
          aws logs get-log-events \
            --log-group-name "$LOG_GROUP" \
            --log-stream-name "$LOG_STREAM" \
            --region ap-northeast-1 \
            --query "events[*].message" \
            --output text
        fi

      - echo "[POST_BUILD] Writing imagedefinitions.json for ECS Deploy..."
      - printf '[{"name":"%s","imageUri":"%s:latest"}]' "$CONTAINER_NAME" "$REPOSITORY_URI" > imagedefinitions.json
      - ls -l imagedefinitions.json
      - cat imagedefinitions.json

artifacts:
  files:
    - imagedefinitions.json


# - |
      #   echo "[POST_BUILD] Running Laravel migration with ${MIGRATION_TASK_DEFINITION}"
      #   TASK_ARN=$(aws ecs run-task \
      #     --cluster ${ECS_CLUSTER_NAME} \
      #     --launch-type FARGATE \
      #     --task-definition ${MIGRATION_TASK_DEFINITION} \
      #     --network-configuration "awsvpcConfiguration={subnets=[${SUBNET_ID_1},${SUBNET_ID_2}],securityGroups=[${SECURITY_GROUP_ID}],assignPublicIp=DISABLED}" \
      #     --region ap-northeast-1 \
      #     --output json \
      #     | tee /tmp/run-task.json \
      #     | jq -r '.tasks[0].taskArn // empty')

      #   echo "[DEBUG] TASK_ARN=${TASK_ARN}"
      #   if [ -z "$TASK_ARN" ] || [ "$TASK_ARN" = "null" ]; then
      #     echo "[ERROR] Failed to start migration task. TASK_ARN is empty."
      #     exit 1
      #   fi

      #   echo "[INFO] Migration task started: $TASK_ARN"
      #   echo "[INFO] Waiting for task to finish..."
      #   aws ecs wait tasks-stopped --cluster ${ECS_CLUSTER_NAME} --tasks $TASK_ARN --region ap-northeast-1