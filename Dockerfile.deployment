FROM public.ecr.aws/docker/library/php:8.2-apache

# å¿…è¦ãªPHPæ‹¡å¼µãƒ»SSM Agentã®ä¾å­˜ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN apt-get update && apt-get install -y \
    unzip \
    git \
    libzip-dev \
    libpng-dev \
    default-mysql-client \
    curl \
    wget \
    gnupg \
    supervisor \
    && docker-php-ext-install pdo pdo_mysql zip bcmath

# Apache mod_rewrite æœ‰åŠ¹åŒ–
RUN a2enmod rewrite

# Composerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
COPY --from=public.ecr.aws/docker/library/composer:latest /usr/bin/composer /usr/bin/composer

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORKDIR /var/www/html

# Laravelã®ã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ”ãƒ¼
COPY . /var/www/html

# Laravelãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
RUN mkdir -p /var/www/html/storage/logs \
&& touch /var/www/html/storage/logs/laravel.log \
&& chown -R www-data:www-data storage bootstrap/cache \
&& chmod -R 775 storage \
&& ln -sf /dev/stdout /var/www/html/storage/logs/laravel.log

# LaravelåˆæœŸè¨­å®š
RUN composer install --no-dev --optimize-autoloader \
 && php artisan config:clear \
 && php artisan cache:clear \
 && php artisan view:clear

# Apacheç”¨ã«DocumentRootã‚’publicã«å¤‰æ›´
RUN sed -i 's|/var/www/html|/var/www/html/public|g' /etc/apache2/sites-available/000-default.conf

# ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ä¿®æ­£
RUN chown -R www-data:www-data storage bootstrap/cache

# ğŸ”½ SSM Agent ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN mkdir -p /tmp/ssm \
 && cd /tmp/ssm \
 && curl -Lo amazon-ssm-agent.deb "https://s3.ap-northeast-1.amazonaws.com/amazon-ssm-ap-northeast-1/latest/debian_amd64/amazon-ssm-agent.deb" \
 && dpkg -i amazon-ssm-agent.deb \
 && rm -rf /tmp/ssm

# ğŸ”½ Supervisor è¨­å®šã‚’è¿½åŠ 
COPY ./supervisord.conf /etc/supervisord.conf

# ãƒãƒ¼ãƒˆå…¬é–‹
EXPOSE 80

# èµ·å‹•ã‚³ãƒãƒ³ãƒ‰: Apache + SSM Agent ã‚’Supervisorã§èµ·å‹•
CMD ["/usr/bin/supervisord", "-c", "/etc/supervisord.conf"]


# FROM public.ecr.aws/docker/library/php:8.2-apache

# # å¿…è¦ãªPHPæ‹¡å¼µãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«
# RUN apt-get update && apt-get install -y \
#     unzip \
#     git \
#     libzip-dev \
#     libpng-dev \
#     default-mysql-client \
#     && docker-php-ext-install pdo pdo_mysql zip bcmath

# # Apacheã®mod_rewriteæœ‰åŠ¹åŒ–
# RUN a2enmod rewrite

# # Composerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
# COPY --from=public.ecr.aws/docker/library/composer:latest /usr/bin/composer /usr/bin/composer

# # ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
# WORKDIR /var/www/html

# # Laravelã®ã‚½ãƒ¼ã‚¹ã‚’ã‚³ãƒ³ãƒ†ãƒŠã«ã‚³ãƒ”ãƒ¼
# COPY . /var/www/html

# # LaravelåˆæœŸè¨­å®š
# WORKDIR /var/www/html

# RUN composer install --no-dev --optimize-autoloader \
#  && php artisan config:clear \
#  && php artisan cache:clear \
#  && php artisan view:clear

# # Apacheç”¨ã«DocumentRootã‚’publicã«å¤‰æ›´
# RUN sed -i 's|/var/www/html|/var/www/html/public|g' /etc/apache2/sites-available/000-default.conf

# # Laravelãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’stdoutã«æµã™
# RUN ln -sf /dev/stdout /var/www/html/storage/logs/laravel.log

# # ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ä¿®æ­£ï¼ˆæ­£ã—ã„ãƒ‘ã‚¹ã«å¤‰æ›´ï¼‰
# RUN chown -R www-data:www-data storage bootstrap/cache

# # ãƒãƒ¼ãƒˆå…¬é–‹
# EXPOSE 80

# # èµ·å‹•
# CMD ["apache2-foreground"]
